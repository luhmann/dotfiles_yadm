#!/usr/bin/env zsh
# @name: gtw
# @description: Git worktree manager
# @category: git
# @keywords: git, worktree, manage
# @usage: gtw [args]
# @example: gtw

gtw () {
  local branch=$1
  [[ -z $branch ]] && { echo "Usage: gtw <branch>"; return 1 }

  # 1. repo information
  local root=$(git rev-parse --show-toplevel 2>/dev/null) \
    || { echo "‚ùå  Not inside a Git repository"; return 1 }
  local repo=${root:t}                     # basename of repo
  local safe_branch=${branch//\//-}        # / ‚Üí -
  local target=${root:h}/${repo}-${safe_branch}

  # 2. existing tree?
  if [[ -d $target ]]; then
    echo "‚úî Work-tree already exists ‚Üí cd $target"
    cd "$target"
    return
  fi

  # 3. create tree (branch new or existing)
  if git show-ref --quiet "refs/heads/$branch"; then
    git worktree add "$target" "$branch"
  else
    # detect default remote branch (falls back to main)
    local def=$(git symbolic-ref --quiet --short refs/remotes/origin/HEAD 2>/dev/null \
                 | cut -d/ -f2)
    [[ -z $def ]] && def=main
    git worktree add -b "$branch" "$target" origin/$def
  fi

  # 4. run creation hook if exists
  local hook_script="${root}/.jf/worktree-create"
  if [[ -f $hook_script ]]; then
    echo "üîß  Running worktree creation hook..."
    cd "$target"

    # Export environment variables for the hook
    export REPO_ROOT="$root"
    export WORKTREE_PATH="$target"
    export WORKTREE_NAME="${target:t}"

    # Make hook executable if not already
    [[ ! -x $hook_script ]] && chmod +x "$hook_script"

    # Run the hook from within the worktree
    if "$hook_script"; then
      echo "‚úÖ  Hook completed successfully"
    else
      echo "‚ùå  Hook failed - removing worktree"
      cd "$root"
      git worktree remove "$target"
      return 1
    fi
  else
    cd "$target"
  fi

  echo "‚úÖ  Now inside $target"
}
