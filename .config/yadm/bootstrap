#!/bin/bash
#
# yadm bootstrap - sets up a fresh macOS machine
#
# Usage:
#   yadm bootstrap              # interactive menu (dev packages only)
#   yadm bootstrap --all        # run all sections (unattended, dev only)
#   yadm bootstrap --personal   # include personal apps in brew bundle
#

set -euo pipefail

INSTALL_PERSONAL=false
for arg in "$@"; do
    case "$arg" in
        --personal) INSTALL_PERSONAL=true ;;
    esac
done

# ---------------------------------------------------------------------------
# Color helpers (tput-based, gracefully degrade if tput unavailable)
# ---------------------------------------------------------------------------
if command -v tput &>/dev/null && [[ -t 1 ]]; then
    GREEN=$(tput setaf 2)
    YELLOW=$(tput setaf 3)
    RED=$(tput setaf 1)
    BOLD=$(tput bold)
    RESET=$(tput sgr0)
else
    GREEN=""
    YELLOW=""
    RED=""
    BOLD=""
    RESET=""
fi

header() {
    echo ""
    echo "${GREEN}${BOLD}==> $1${RESET}"
}

ok() {
    echo "${GREEN}[OK]${RESET} $1"
}

skip() {
    echo "${YELLOW}[SKIP]${RESET} $1"
}

warn() {
    echo "${YELLOW}[WARN]${RESET} $1"
}

fail() {
    echo "${RED}[ERROR]${RESET} $1"
}

# ---------------------------------------------------------------------------
# Section 1: SSH key setup
# ---------------------------------------------------------------------------
generate_ssh_key() {
    local key_name="$1"
    local email="$2"
    local key_path="$HOME/.ssh/$key_name"

    if [[ -f "$key_path" ]]; then
        skip "SSH key already exists at $key_path."
        return 1
    fi

    ssh-keygen -t ed25519 -C "$email" -f "$key_path" -N ""
    ok "Generated $key_path"
}

add_ssh_keys_to_github() {
    if ! command -v gh &>/dev/null; then
        warn "gh CLI not found. Skipping GitHub upload."
        return 0
    fi

    if ! gh auth status &>/dev/null 2>&1; then
        echo "Not logged into GitHub. Authenticating..."
        gh auth login
    fi

    # Collect all public keys
    local pub_keys=()
    while IFS= read -r -d '' f; do
        pub_keys+=("$f")
    done < <(find "$HOME/.ssh" -name "*.pub" -print0 | sort -z)

    if [[ ${#pub_keys[@]} -eq 0 ]]; then
        warn "No SSH public keys found in ~/.ssh/"
        return 0
    fi

    echo ""
    echo "${BOLD}Select SSH keys to add to GitHub:${RESET}"
    echo ""

    local i=1
    for key in "${pub_keys[@]}"; do
        local key_comment
        key_comment=$(awk '{print $3}' "$key" 2>/dev/null)
        local key_basename
        key_basename=$(basename "$key")
        echo "  $i) ${key_basename} ${YELLOW}(${key_comment:-no comment})${RESET}"
        ((i++))
    done
    echo "  a) All keys"
    echo "  q) Skip"
    echo ""
    read -rp "Choose (comma-separated, e.g. 1,3): " selection

    if [[ "$selection" == "q" ]]; then
        skip "Skipping GitHub key upload."
        return 0
    fi

    local selected_keys=()
    if [[ "$selection" == "a" ]]; then
        selected_keys=("${pub_keys[@]}")
    else
        IFS=',' read -ra indices <<< "$selection"
        for idx in "${indices[@]}"; do
            idx=$(echo "$idx" | tr -d ' ')
            if [[ "$idx" =~ ^[0-9]+$ ]] && (( idx >= 1 && idx <= ${#pub_keys[@]} )); then
                selected_keys+=("${pub_keys[$((idx-1))]}")
            else
                warn "Invalid selection: $idx"
            fi
        done
    fi

    local hostname
    hostname=$(scutil --get ComputerName 2>/dev/null || hostname -s)

    for key in "${selected_keys[@]}"; do
        local key_basename
        key_basename=$(basename "$key" .pub)
        local title="${hostname} (${key_basename})"

        if gh ssh-key add "$key" --title "$title" 2>/dev/null; then
            ok "Added $(basename "$key") to GitHub as \"$title\""
        else
            warn "Failed to add $(basename "$key") (may already exist on GitHub)"
        fi
    done
}

setup_ssh() {
    header "Setting up SSH keys..."

    mkdir -p "$HOME/.ssh"
    chmod 700 "$HOME/.ssh"

    # Generate default key if missing
    generate_ssh_key "id_ed25519" "jfd@daenen4.de" || true

    # Offer to generate additional keys
    while true; do
        echo ""
        read -rp "Generate another SSH key? (y/n): " answer
        case "$answer" in
            [yY])
                read -rp "  Key name (e.g. id_work): " key_name
                read -rp "  Email: " email
                if [[ -n "$key_name" && -n "$email" ]]; then
                    generate_ssh_key "$key_name" "$email" || true
                else
                    warn "Key name and email are required."
                fi
                ;;
            *) break ;;
        esac
    done

    ok "SSH key setup complete."
}

# ---------------------------------------------------------------------------
# Section 6: Add SSH keys to GitHub (requires gh from brew bundle)
# ---------------------------------------------------------------------------
setup_github_ssh() {
    header "Adding SSH keys to GitHub..."

    add_ssh_keys_to_github
}

# ---------------------------------------------------------------------------
# Section 2: Xcode Command Line Tools
# ---------------------------------------------------------------------------
setup_xcode_cli() {
    header "Installing Xcode Command Line Tools..."

    if xcode-select -p &>/dev/null; then
        skip "Xcode CLI tools already installed at $(xcode-select -p)."
        return 0
    fi

    echo "This may take a while."

    touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress

    local label
    label=$(softwareupdate -l 2>&1 \
        | grep "\*.*Command Line" \
        | tail -n 1 \
        | awk -F"*" '{print $2}' \
        | sed -e 's/^ *//' \
        | tr -d '\n')

    if [[ -n "$label" ]]; then
        softwareupdate -i "$label" --verbose
    else
        warn "Could not find CLI tools via softwareupdate. Falling back to xcode-select --install."
        xcode-select --install
        echo "${YELLOW}Press Enter after the installation dialog completes...${RESET}"
        read -r
    fi

    rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress

    ok "Xcode CLI tools installed."
}

# ---------------------------------------------------------------------------
# Section 3: Create ~/dev and ~/icloud
# ---------------------------------------------------------------------------
setup_dev_dir() {
    header "Creating ~/dev and ~/icloud..."

    if [[ -d "$HOME/dev" ]]; then
        skip "~/dev already exists."
    else
        mkdir -p "$HOME/dev"
        ok "~/dev created."
    fi

    if [[ -L "$HOME/icloud" ]]; then
        skip "~/icloud symlink already exists."
    else
        ln -s "$HOME/Library/Mobile Documents/com~apple~CloudDocs" "$HOME/icloud"
        ok "~/icloud symlink created."
    fi
}

# ---------------------------------------------------------------------------
# Section 4: Install Homebrew
# ---------------------------------------------------------------------------
setup_homebrew() {
    header "Installing Homebrew..."

    if command -v brew &>/dev/null; then
        skip "Homebrew already installed at $(command -v brew)."
        return 0
    fi

    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add brew to PATH for the rest of this session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi

    ok "Homebrew installed."
}

# ---------------------------------------------------------------------------
# Section 5: Brew bundle + fzf setup
# ---------------------------------------------------------------------------
setup_brew_bundle() {
    header "Running brew bundle + fzf setup..."

    if ! command -v brew &>/dev/null; then
        fail "Homebrew is not installed. Run section 4 first."
        return 1
    fi

    local brewfile_dev="$HOME/Brewfile.dev"
    local brewfile_personal="$HOME/Brewfile.personal"

    if [[ -f "$brewfile_dev" ]]; then
        echo "Running brew bundle for dev tools..."
        brew bundle --file="$brewfile_dev"
        ok "Dev brew bundle complete."
    else
        warn "No Brewfile.dev found at $brewfile_dev. Skipping."
    fi

    if [[ "$INSTALL_PERSONAL" == true ]]; then
        if [[ -f "$brewfile_personal" ]]; then
            echo "Running brew bundle for personal apps..."
            brew bundle --file="$brewfile_personal"
            ok "Personal brew bundle complete."
        else
            warn "No Brewfile.personal found at $brewfile_personal. Skipping."
        fi
    else
        skip "Personal apps skipped (use --personal to include)."
    fi

    local fzf_install
    fzf_install="$(brew --prefix)/opt/fzf/install"
    if [[ -x "$fzf_install" ]]; then
        echo "Setting up fzf key bindings and completion..."
        "$fzf_install" --no-bash --no-fish --key-bindings --completion --no-update-rc
        ok "fzf setup complete."
    else
        warn "fzf install script not found at $fzf_install. Is fzf in your Brewfile?"
    fi

    ok "Brew bundle section complete."
}

# ---------------------------------------------------------------------------
# Section 7: Install Claude Code (auto-updating)
# ---------------------------------------------------------------------------
setup_claude_code() {
    header "Installing Claude Code..."

    if command -v claude &>/dev/null; then
        skip "Claude Code already installed at $(command -v claude)."
        return 0
    fi

    curl -fsSL https://claude.ai/install.sh | bash

    ok "Claude Code installed."
}

# ---------------------------------------------------------------------------
# Section 8: Install MonoLisa font from 1Password
# ---------------------------------------------------------------------------
setup_monolisa() {
    header "Installing MonoLisa font..."

    if ls "$HOME/Library/Fonts"/MonoLisa-*.otf &>/dev/null; then
        skip "MonoLisa fonts already installed."
        return 0
    fi

    if ! command -v op &>/dev/null; then
        warn "1Password CLI not found. Skipping MonoLisa install."
        return 0
    fi

    local tmpzip
    tmpzip=$(mktemp /tmp/monolisa-XXXXXX.zip)

    if op document get "33gu4ruy7ky3zydk5la5vflda4" --out-file "$tmpzip" 2>/dev/null; then
        mkdir -p "$HOME/Library/Fonts"
        unzip -o "$tmpzip" -d "$HOME/Library/Fonts"
        rm -f "$tmpzip"
        ok "MonoLisa fonts installed."
    else
        rm -f "$tmpzip"
        warn "Could not retrieve MonoLisa from 1Password. Are you signed in? (eval \$(op signin))"
    fi
}

# ---------------------------------------------------------------------------
# Section 9: Sync API keys from 1Password to macOS keychain
# ---------------------------------------------------------------------------
setup_api_keys() {
    header "Syncing API keys from 1Password to macOS keychain..."

    if ! command -v op &>/dev/null; then
        warn "1Password CLI not found. Skipping API key sync."
        return 0
    fi

    if ! op vault list &>/dev/null 2>&1; then
        warn "1Password is locked. Unlock and retry. (eval \$(op signin))"
        return 0
    fi

    local keys=(
        "openai-api-key"
        "gemini-api-key"
        "openrouter-api-key"
        "jira-api-token"
        "anthropic-api-key"
        "brave-api-key"
    )

    for key_name in "${keys[@]}"; do
        local secret
        secret=$(op read "op://Automation/${key_name}/credential" --no-newline 2>/dev/null)

        if [[ -z "$secret" ]]; then
            warn "Could not read ${key_name} from 1Password. Skipping."
            continue
        fi

        security add-generic-password -a "$USER" -s "$key_name" -w "$secret" -U 2>/dev/null
        ok "$key_name"
    done
}

# ---------------------------------------------------------------------------
# Section 10: Disable Spotlight shortcut (for Raycast)
# ---------------------------------------------------------------------------
setup_spotlight() {
    header "Disabling Spotlight shortcut (for Raycast)..."

    local plist="$HOME/Library/Preferences/com.apple.symbolichotkeys.plist"

    if [[ ! -f "$plist" ]]; then
        warn "Plist file not found at $plist. Skipping."
        return 0
    fi

    if /usr/libexec/PlistBuddy "$plist" \
        -c "Set AppleSymbolicHotKeys:64:enabled false" 2>/dev/null; then
        ok "Spotlight shortcut disabled."
    else
        warn "Could not disable Spotlight shortcut (may already be disabled or key path differs)."
    fi
}

# ---------------------------------------------------------------------------
# Section 11: Apply macOS defaults
# ---------------------------------------------------------------------------
setup_macos_defaults() {
    header "Applying macOS defaults..."

    local defaults_script="$HOME/.config/yadm/macos-defaults.bash"

    if [[ ! -f "$defaults_script" ]]; then
        warn "macOS defaults script not found at $defaults_script. Skipping."
        return 0
    fi

    bash "$defaults_script"
    ok "macOS defaults applied."
}

# ---------------------------------------------------------------------------
# --all mode: run everything in order
# ---------------------------------------------------------------------------
if [[ " $* " == *" --all "* ]] || [[ "${1:-}" == "--all" ]]; then
    setup_ssh
    setup_xcode_cli
    setup_dev_dir
    setup_homebrew
    setup_brew_bundle
    setup_github_ssh
    setup_claude_code
    setup_monolisa
    setup_api_keys
    setup_spotlight
    setup_macos_defaults
    echo ""
    echo "${GREEN}${BOLD}Done!${RESET}"
    exit 0
fi

# ---------------------------------------------------------------------------
# Interactive menu
# ---------------------------------------------------------------------------
while true; do
    echo ""
    echo "${BOLD}yadm bootstrap${RESET}"
    if [[ "$INSTALL_PERSONAL" == true ]]; then
        echo "==============${YELLOW} [+personal]${RESET}"
    else
        echo "==============${YELLOW} [dev only]${RESET}"
    fi
    echo "  1) SSH key setup"
    echo "  2) Xcode Command Line Tools"
    echo "  3) Create ~/dev directory"
    echo "  4) Install Homebrew"
    echo "  5) Brew bundle (install packages)"
    echo "  6) Add SSH keys to GitHub"
    echo "  7) Install Claude Code"
    echo "  8) Install MonoLisa font"
    echo "  9) Sync API keys from 1Password"
    echo " 10) Disable Spotlight shortcut (for Raycast)"
    echo " 11) Apply macOS defaults"
    echo "  a) Run all"
    echo "  q) Quit"
    echo ""
    read -rp "Choose: " choice
    case "$choice" in
        1) setup_ssh ;;
        2) setup_xcode_cli ;;
        3) setup_dev_dir ;;
        4) setup_homebrew ;;
        5) setup_brew_bundle ;;
        6) setup_github_ssh ;;
        7) setup_claude_code ;;
        8) setup_monolisa ;;
        9) setup_api_keys ;;
        10) setup_spotlight ;;
        11) setup_macos_defaults ;;
        a)
            setup_ssh
            setup_xcode_cli
            setup_dev_dir
            setup_homebrew
            setup_brew_bundle
            setup_github_ssh
            setup_claude_code
            setup_monolisa
            setup_api_keys
            setup_spotlight
            setup_macos_defaults
            echo ""
            echo "${GREEN}${BOLD}Done!${RESET}"
            ;;
        q) exit 0 ;;
        *) echo "Invalid choice." ;;
    esac
done
